<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ComfyUI Studio V13</title>
    <meta name="theme-color" content="#0a0a0a">
    
    <!-- PWA Manifest -->
    <script>
        const manifest = {
            "name": "ComfyUI Studio",
            "short_name": "ComfyUI",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0a0a0a",
            "theme_color": "#0a0a0a",
            "icons": [{
                "src": "https://cdnjs.cloudflare.com/ajax/libs/octicons/8.5.0/svg/zap.svg",
                "sizes": "192x192",
                "type": "image/svg+xml"
            }]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = URL.createObjectURL(blob);
        document.head.appendChild(link);
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React Dependencies -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { background-color: #0a0a0a; color: #e5e5e5; -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; font-family: sans-serif; touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="range"] { accent-color: #10b981; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- ÍCONES SVG ---
        const Icons = {
            Zap: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Settings: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Image: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            History: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            FolderOpen: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"/></svg>,
            Save: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>,
            Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Download: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            CheckCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            RefreshCw: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Sliders: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="2" x2="6" y1="14" y2="14"/><line x1="10" x2="14" y1="8" y2="8"/><line x1="18" x2="22" y1="16" y2="16"/></svg>,
            ChevronDown: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>,
            Lock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            FileJson: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1"/><path d="M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1"/></svg>,
            Clipboard: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>,
            Brain: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-3.284"/><path d="M17.97 14.716A4 4 0 0 1 18 18"/></svg>,
            Aperture: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m14.31 8 5.74 9.94"/><path d="M9.69 8h11.48"/><path d="m7.38 12 5.74-9.94"/><path d="M9.69 16 3.95 6.06"/><path d="M14.31 16H2.83"/><path d="m16.62 12-5.74 9.94"/></svg>,
            List: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
        };

        const { useState, useEffect } = React;

        const SAMPLERS = ["euler", "euler_ancestral", "heun", "dpm_2", "dpm_2_ancestral", "lms", "dpm_fast", "dpm_adaptive", "dpmpp_2s_ancestral", "dpmpp_2m", "dpmpp_2m_sde", "dpmpp_2m_sde_gpu", "ddim", "uni_pc", "lcm"];
        const SCHEDULERS = ["normal", "karras", "exponential", "sgm_uniform", "simple", "ddim_uniform", "beta"];
        const WORKFLOW_FALLBACK = {
            "3": { "inputs": { "seed": 0, "steps": 20, "cfg": 8, "sampler_name": "euler", "scheduler": "normal", "denoise": 1, "model": ["4", 0], "positive": ["6", 0], "negative": ["7", 0], "latent_image": ["5", 0] }, "class_type": "KSampler" },
            "4": { "inputs": { "ckpt_name": "v1-5-pruned-emaonly.ckpt" }, "class_type": "CheckpointLoaderSimple" },
            "5": { "inputs": { "width": 512, "height": 512, "batch_size": 1 }, "class_type": "EmptyLatentImage" },
            "6": { "inputs": { "text": "", "clip": ["4", 1] }, "class_type": "CLIPTextEncode" },
            "7": { "inputs": { "text": "", "clip": ["4", 1] }, "class_type": "CLIPTextEncode" },
            "8": { "inputs": { "samples": ["3", 0], "vae": ["4", 2] }, "class_type": "VAEDecode" },
            "9": { "inputs": { "filename_prefix": "Mobile_Gen", "images": ["8", 0] }, "class_type": "SaveImage" }
        };

        function App() {
            const [serverUrl, setServerUrl] = useState(() => localStorage.getItem('comfy_url') || '');
            const [llmServerUrl, setLlmServerUrl] = useState(() => localStorage.getItem('comfy_llm_url') || ''); // Novo Estado para LLM
            const [activeTab, setActiveTab] = useState('settings');
            const [isConnected, setIsConnected] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('idle');
            
            // Params
            const [positivePrompt, setPositivePrompt] = useState('');
            const [negativePrompt, setNegativePrompt] = useState('');
            const [imageSize, setImageSize] = useState({ w: 512, h: 512 });
            const [steps, setSteps] = useState(20);
            const [cfg, setCfg] = useState(7.0);
            const [sampler, setSampler] = useState('euler');
            const [scheduler, setScheduler] = useState('normal');
            
            const [imageSeed, setImageSeed] = useState(-1);
            const [llmSeed, setLlmSeed] = useState(-1);
            
            const [showAdvanced, setShowAdvanced] = useState(false);
            const [showTagEditor, setShowTagEditor] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [isLlmLoading, setIsLlmLoading] = useState(false);
            
            const [models, setModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState('');
            const [history, setHistory] = useState([]);
            const [lastImage, setLastImage] = useState(null);
            const [presets, setPresets] = useState([]);
            
            const [customWorkflow, setCustomWorkflow] = useState(null); 
            const [customWorkflowName, setCustomWorkflowName] = useState('');
            const [isModelLocked, setIsModelLocked] = useState(false);

            useEffect(() => {
                if (serverUrl) checkConnection(serverUrl, true);
                try {
                    const sp = localStorage.getItem('comfy_presets');
                    if (sp) setPresets(JSON.parse(sp));
                    const sh = localStorage.getItem('comfy_history');
                    if (sh) setHistory(JSON.parse(sh));
                } catch(e) {}
            }, []);

            const handleUrlChange = (e) => {
                setServerUrl(e.target.value);
                localStorage.setItem('comfy_url', e.target.value);
            };

            const handleLlmUrlChange = (e) => {
                setLlmServerUrl(e.target.value);
                localStorage.setItem('comfy_llm_url', e.target.value);
            };

            const handlePaste = async (setter, storageKey) => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) { setter(text); localStorage.setItem(storageKey, text); }
                } catch (err) { alert("Use o colar do teclado (Permissão negada)"); }
            };

            const downloadImage = async (url, name) => {
                try {
                    const res = await fetch(url);
                    const blob = await res.blob();
                    const bUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = bUrl; a.download = name;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                } catch(e) { window.open(url, '_blank'); }
            };

            // --- LLM GENERATION (COM SUPORTE A NGROK/HTTPS) ---
            const generateFromLLM = async () => {
                if (!positivePrompt) return alert("Digite uma ideia básica primeiro!");
                setIsLlmLoading(true);
                try {
                    let targetUrl;
                    
                    // Se o usuário digitou uma URL específica (ex: Ngrok), usa ela
                    if (llmServerUrl) {
                        targetUrl = llmServerUrl.trim().replace(/\/$/, '') + '/v1/chat/completions';
                    } else {
                        // Fallback: Tenta adivinhar (Só funciona se for HTTP -> HTTP)
                        const ipMatch = serverUrl.match(/:\/\/(.[^/]+)/);
                        if (!ipMatch) throw new Error("Configure a URL da LLM na aba Config.");
                        const cleanIp = ipMatch[1].split(':')[0]; 
                        targetUrl = `http://${cleanIp}:1234/v1/chat/completions`;
                    }

                    const payload = {
                        messages: [
                            { role: "system", content: "You are a prompt generator. Output raw prompt tags separated by commas. Focus on visual description." },
                            { role: "user", content: `Create detailed prompt for: ${positivePrompt}` }
                        ],
                        temperature: 0.7,
                        max_tokens: 300
                    };

                    const res = await fetch(targetUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    if (data.choices && data.choices[0]) {
                        setPositivePrompt(data.choices[0].message.content);
                        setShowTagEditor(true);
                    }
                } catch (e) {
                    alert(`Erro LLM: ${e.message}\n\nDica: Se você usa o App via HTTPS (GitHub), o LM Studio TAMBÉM precisa ser HTTPS (Use ngrok http 1234 e cole o link na aba Config).`);
                } finally {
                    setIsLlmLoading(false);
                }
            };

            const checkConnection = async (url, silent = false) => {
                if (!url) return;
                if (!silent) setConnectionStatus('connecting');
                let clean = url.trim().replace(/\/$/, '');
                if (!clean.startsWith('http')) clean = 'https://' + clean; 
                try {
                    const c = new AbortController();
                    const id = setTimeout(() => c.abort(), 5000);
                    const res = await fetch(`${clean}/system_stats`, { signal: c.signal });
                    clearTimeout(id);
                    if (res.ok) {
                        setIsConnected(true);
                        setConnectionStatus('connected');
                        if (clean !== url) { setServerUrl(clean); localStorage.setItem('comfy_url', clean); }
                        fetchModels(clean);
                        if (!silent) setActiveTab('generate');
                    } else throw new Error(res.status);
                } catch (e) {
                    setIsConnected(false);
                    setConnectionStatus('error');
                    if (!silent) alert("Erro: " + e.message);
                }
            };

            const fetchModels = async (url) => {
                try {
                    const res = await fetch(`${url}/object_info/CheckpointLoaderSimple`);
                    const data = await res.json();
                    const list = data.CheckpointLoaderSimple?.input?.required?.ckpt_name[0] || [];
                    setModels(list);
                    if (!selectedModel && list.length > 0 && !isModelLocked) setSelectedModel(list[0]);
                } catch(e) {}
            };

            // --- INJEÇÃO INTELIGENTE (V12) ---
            const injectTextIntoWorkflow = (wf, text, type) => {
                const kSamplerId = Object.keys(wf).find(k => wf[k].class_type.toLowerCase().includes("ksampler"));
                if (!kSamplerId) return;

                const kInputs = wf[kSamplerId].inputs;
                const linkKey = type === 'positive' ? 'positive' : 'negative';
                
                if (Array.isArray(kInputs[linkKey])) {
                    const targetId = kInputs[linkKey][0];
                    if (wf[targetId] && wf[targetId].inputs) {
                        console.log(`Injecting ${type} into node ${targetId}`);
                        if (wf[targetId].inputs.text !== undefined) wf[targetId].inputs.text = text;
                        if (wf[targetId].inputs.text_g !== undefined) wf[targetId].inputs.text_g = text;
                        if (wf[targetId].inputs.text_l !== undefined) wf[targetId].inputs.text_l = text;
                        
                        // Break links
                        ['text', 'text_g', 'text_l'].forEach(k => {
                            if (Array.isArray(wf[targetId].inputs[k])) wf[targetId].inputs[k] = text;
                        });
                    }
                }
            };

            const generate = async () => {
                if (!isConnected) return setActiveTab('settings');
                setIsGenerating(true);

                const finalImgSeed = imageSeed === -1 ? Math.floor(Math.random()*1e9) : imageSeed;
                const clientId = crypto.randomUUID();
                let wf = JSON.parse(JSON.stringify(customWorkflow || WORKFLOW_FALLBACK));

                Object.keys(wf).forEach(nid => {
                    const node = wf[nid];
                    const type = node.class_type.toLowerCase();
                    const inp = node.inputs;

                    if (type.includes("ksampler")) {
                        if(inp.seed!==undefined) inp.seed = finalImgSeed;
                        if(inp.noise_seed!==undefined) inp.noise_seed = finalImgSeed;
                        if(inp.steps!==undefined) inp.steps = steps;
                        if(inp.cfg!==undefined) inp.cfg = cfg;
                        if(inp.sampler_name!==undefined) inp.sampler_name = sampler;
                        if(inp.scheduler!==undefined) inp.scheduler = scheduler;
                    }
                    if (!isModelLocked && type === "checkpointloadersimple" && selectedModel) inp.ckpt_name = selectedModel;
                    if (["emptylatentimage","emptysd3latentimage"].includes(type)) { inp.width = imageSize.w; inp.height = imageSize.h; }
                });

                if (positivePrompt) injectTextIntoWorkflow(wf, positivePrompt, 'positive');
                if (negativePrompt) injectTextIntoWorkflow(wf, negativePrompt, 'negative');

                try {
                    const res = await fetch(`${serverUrl}/prompt`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ client_id: clientId, prompt: wf })
                    });
                    const d = await res.json();
                    
                    let attempts = 0;
                    const poll = setInterval(async () => {
                        attempts++;
                        if (attempts > 120) { clearInterval(poll); setIsGenerating(false); return; }
                        try {
                            const hRes = await fetch(`${serverUrl}/history/${d.prompt_id}`);
                            const hData = await hRes.json();
                            if (hData[d.prompt_id]) {
                                const out = hData[d.prompt_id].outputs;
                                const k = Object.keys(out).find(x => out[x].images);
                                if (k) {
                                    const img = out[k].images[0];
                                    const url = `${serverUrl}/view?filename=${img.filename}&subfolder=${img.subfolder}&type=${img.type}`;
                                    const item = { url, imageSeed: finalImgSeed, prompt: positivePrompt, steps };
                                    setLastImage(item);
                                    setHistory(prev => [item, ...prev]);
                                    localStorage.setItem('comfy_history', JSON.stringify([item, ...history].slice(0,20)));
                                    clearInterval(poll);
                                    setIsGenerating(false);
                                }
                            }
                        } catch(e) {}
                    }, 1000);
                } catch(e) { alert(e.message); setIsGenerating(false); }
            };

            const handleJson = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const j = JSON.parse(ev.target.result);
                        if(j.nodes) return alert("Use API Format");
                        setCustomWorkflow(j);
                        setCustomWorkflowName(f.name.replace('.json',''));
                        const kid = Object.keys(j).find(k=>j[k].class_type?.toLowerCase().includes("ksampler"));
                        if(kid) {
                            const i = j[kid].inputs;
                            setSteps(i.steps||20); setCfg(i.cfg||7);
                        }
                        const complex = ["UNETLoader","DualCLIPLoader","Load Diffusion Model"].some(t=>Object.values(j).some(n=>n.class_type===t));
                        setIsModelLocked(complex);
                        alert("Workflow Carregado v12!");
                        setActiveTab('generate');
                    } catch(err) { alert("JSON Inválido"); }
                };
                r.readAsText(f);
            };

            const savePreset = () => {
                const n = prompt("Nome:");
                if(n) {
                    const p = {name:n, positivePrompt, negativePrompt, steps, cfg, sampler, scheduler, imageSeed, llmSeed, imageSize, customWorkflow, customWorkflowName, isModelLocked, selectedModel};
                    const up = [...presets, p];
                    setPresets(up);
                    localStorage.setItem('comfy_presets', JSON.stringify(up));
                }
            };

            const loadPreset = (p) => {
                setPositivePrompt(p.positivePrompt); setNegativePrompt(p.negativePrompt); setImageSize(p.imageSize);
                setSteps(p.steps); setCfg(p.cfg); setSampler(p.sampler); setScheduler(p.scheduler);
                setImageSeed(p.imageSeed||-1); setLlmSeed(p.llmSeed||-1);
                if(p.selectedModel) setSelectedModel(p.selectedModel);
                setCustomWorkflow(p.customWorkflow); setCustomWorkflowName(p.customWorkflowName); setIsModelLocked(!!p.isModelLocked);
                setActiveTab('generate');
            };

            const TagEditor = () => {
                const tags = positivePrompt.split(',').map(t => t.trim()).filter(t => t);
                const updateTags = (newTags) => setPositivePrompt(newTags.join(', '));
                return (
                    <div className="fixed inset-0 bg-black/95 z-50 p-4 flex flex-col fade-in">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-white flex gap-2"><Icons.List size={20}/> Editor de Tags</h3>
                            <button onClick={() => setShowTagEditor(false)}><Icons.X size={24} className="text-neutral-400"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto space-y-2">
                            {tags.map((tag, i) => (
                                <div key={i} className="flex gap-2 items-center bg-neutral-900 p-3 rounded-xl border border-neutral-800">
                                    <input className="flex-1 bg-transparent text-sm outline-none text-emerald-300 font-mono" value={tag} onChange={(e) => { const n = [...tags]; n[i] = e.target.value; updateTags(n); }} />
                                    <button onClick={() => { const n = tags.filter((_, idx) => idx !== i); updateTags(n); }} className="text-red-500 p-1"><Icons.Trash2 size={16}/></button>
                                </div>
                            ))}
                        </div>
                        <button onClick={() => setShowTagEditor(false)} className="mt-4 w-full bg-emerald-600 py-3 rounded-xl font-bold text-white">Confirmar</button>
                    </div>
                );
            };

            const NavItem = ({id, icon:Icon, label}) => (
                <button onClick={()=>setActiveTab(id)} className={`flex flex-col items-center justify-center w-16 h-14 ${activeTab===id?'text-emerald-400':'text-neutral-500'} active:scale-95 transition-all`}>
                    <Icon size={24} strokeWidth={activeTab===id?2.5:2} />
                    <span className="text-[10px] font-bold mt-1">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen pb-24 font-sans">
                    {showTagEditor && <TagEditor />}
                    
                    {/* Header */}
                    <div onClick={()=>setActiveTab('settings')} className={`p-3 px-4 flex justify-between items-center ${isConnected?'bg-emerald-900/30 border-b border-emerald-800':'bg-red-900/30 border-b border-red-800'} transition-colors`}>
                        <div className="flex items-center gap-2">
                            <div className={`w-2 h-2 rounded-full ${isConnected?'bg-emerald-400 shadow-[0_0_8px_#34d399]':'bg-red-500'}`}></div>
                            <span className="text-xs font-bold uppercase tracking-wider text-neutral-300">{isConnected?'Online':'Offline'}</span>
                        </div>
                        <span className="text-[10px] font-mono opacity-50 truncate max-w-[150px]">{serverUrl||'Configurar'}</span>
                    </div>

                    {/* GENERATE */}
                    {activeTab === 'generate' && (
                        <div className="p-4 space-y-5 fade-in">
                            <div className="aspect-square bg-neutral-900 rounded-2xl overflow-hidden relative shadow-2xl border border-neutral-800 flex items-center justify-center">
                                {lastImage ? (
                                    <>
                                        <img src={lastImage.url} className="w-full h-full object-contain bg-black" />
                                        <button onClick={(e)=>{e.stopPropagation();downloadImage(lastImage.url, `img_${lastImage.imageSeed}.png`)}} className="absolute top-3 right-3 bg-black/60 text-white p-2 rounded-full border border-white/20 active:scale-90"><Icons.Download size={20}/></button>
                                    </>
                                ) : <div className="text-neutral-700 flex flex-col items-center"><Icons.Image size={48}/><span className="text-xs mt-2">Pronto</span></div>}
                                {isGenerating && <div className="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-20"><Icons.RefreshCw className="animate-spin text-emerald-500 mb-2" size={32}/><span className="text-emerald-500 font-bold tracking-widest text-sm">CRIANDO...</span></div>}
                            </div>

                            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                {customWorkflow ? 
                                    <div className="flex items-center gap-2 bg-purple-900/30 border border-purple-500/30 px-3 py-1.5 rounded-full text-[10px] text-purple-200 shrink-0"><Icons.FileJson size={12}/> {customWorkflowName} <button onClick={()=>{setCustomWorkflow(null);setCustomWorkflowName('');setIsModelLocked(false)}} className="ml-2"><Icons.X size={10}/></button></div> 
                                    : <div className="flex items-center gap-2 bg-blue-900/20 border border-blue-500/30 px-3 py-1.5 rounded-full text-[10px] text-blue-200 shrink-0"><Icons.Zap size={12}/> Padrão</div>
                                }
                                {isModelLocked && <div className="flex items-center gap-2 bg-yellow-900/20 border border-yellow-500/30 px-3 py-1.5 rounded-full text-[10px] text-yellow-200 shrink-0"><Icons.Lock size={12}/> Modelo Travado</div>}
                            </div>

                            <div className="space-y-3">
                                <div className="relative">
                                    <textarea value={positivePrompt} onChange={e=>setPositivePrompt(e.target.value)} className="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-4 text-sm focus:border-emerald-500/50 outline-none min-h-[120px] pr-12" placeholder="Ideia (Ex: Anime girl blue hair...)" />
                                    <div className="absolute right-2 top-2 flex flex-col gap-2">
                                        <button onClick={generateFromLLM} disabled={isLlmLoading} className="bg-purple-600/20 text-purple-400 p-2 rounded-lg border border-purple-500/30 hover:bg-purple-600 hover:text-white transition-colors">{isLlmLoading ? <Icons.RefreshCw className="animate-spin" size={16}/> : <Icons.Brain size={16}/>}</button>
                                        <button onClick={()=>setShowTagEditor(true)} className="bg-neutral-800 text-neutral-400 p-2 rounded-lg border border-neutral-700 hover:text-white transition-colors"><Icons.List size={16}/></button>
                                    </div>
                                </div>
                                <input value={negativePrompt} onChange={e=>setNegativePrompt(e.target.value)} className="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-3 text-xs text-red-200/80 focus:border-red-900/50 outline-none" placeholder="Negativo" />
                            </div>

                            <div className="border border-neutral-800 rounded-xl overflow-hidden bg-neutral-900/30">
                                <button onClick={()=>setShowAdvanced(!showAdvanced)} className="w-full p-3 flex justify-between items-center text-xs font-bold text-neutral-400 hover:text-white"><span className="flex items-center gap-2"><Icons.Sliders size={14}/> Ajustes</span> {showAdvanced?<Icons.ChevronUp size={14}/>:<Icons.ChevronDown size={14}/>}</button>
                                {showAdvanced && (
                                    <div className="p-4 space-y-5 border-t border-neutral-800 fade-in">
                                        <div className="grid grid-cols-2 gap-6">
                                            <div className="space-y-2"><div className="flex justify-between text-[10px] uppercase font-bold text-neutral-500"><span>Steps</span> <span className="text-emerald-400">{steps}</span></div><input type="range" min="1" max="60" value={steps} onChange={e=>setSteps(Number(e.target.value))} className="w-full h-1.5 bg-neutral-700 rounded-lg"/></div>
                                            <div className="space-y-2"><div className="flex justify-between text-[10px] uppercase font-bold text-neutral-500"><span>CFG</span> <span className="text-emerald-400">{cfg}</span></div><input type="range" min="0.5" max="20" step="0.1" value={cfg} onChange={e=>setCfg(Number(e.target.value))} className="w-full h-1.5 bg-neutral-700 rounded-lg"/></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3 pt-2 border-t border-neutral-800/50">
                                            <div><label className="text-[10px] uppercase font-bold text-neutral-500 mb-1.5 flex gap-1"><Icons.Aperture size={10}/> Img Seed</label><div className="flex gap-2"><input type="number" value={imageSeed} onChange={e=>setImageSeed(Number(e.target.value))} className="w-full bg-neutral-800 text-xs rounded-lg p-2.5 outline-none border border-neutral-700"/><button onClick={()=>setImageSeed(-1)} className="bg-neutral-800 px-3 rounded-lg border border-neutral-700 text-neutral-400"><Icons.RefreshCw size={14}/></button></div></div>
                                            <div><label className="text-[10px] uppercase font-bold text-purple-400 mb-1.5 flex gap-1"><Icons.Brain size={10}/> LLM Seed</label><div className="flex gap-2"><input type="number" value={llmSeed} onChange={e=>setLlmSeed(Number(e.target.value))} className="w-full bg-neutral-800 text-xs rounded-lg p-2.5 outline-none border border-purple-500/30"/><button onClick={()=>setLlmSeed(-1)} className="bg-neutral-800 px-3 rounded-lg border border-purple-500/30 text-purple-400"><Icons.RefreshCw size={14}/></button></div></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div><label className="text-[10px] font-bold text-neutral-500 block mb-1">Sampler</label><select value={sampler} onChange={e=>setSampler(e.target.value)} className="w-full bg-neutral-800 text-xs rounded-lg p-2 border border-neutral-700">{SAMPLERS.map(s=><option key={s} value={s}>{s}</option>)}</select></div>
                                            <div><label className="text-[10px] font-bold text-neutral-500 block mb-1">Tamanho</label><select value={`${imageSize.w}x${imageSize.h}`} onChange={e=>{const[w,h]=e.target.value.split('x').map(Number);setImageSize({w,h})}} className="w-full bg-neutral-800 text-xs rounded-lg p-2 border border-neutral-700"><option value="512x512">512x512</option><option value="512x768">512x768</option><option value="768x512">768x512</option><option value="1024x1024">SDXL 1024</option><option value="768x1152">Z-Turbo</option></select></div>
                                        </div>
                                        <div className={isModelLocked?'opacity-50 pointer-events-none':''}><label className="text-[10px] font-bold text-neutral-500 block mb-1">Modelo {isModelLocked && '(Fixo)'}</label><select value={selectedModel} onChange={e=>setSelectedModel(e.target.value)} className="w-full bg-neutral-800 text-xs rounded-lg p-2 border border-neutral-700 truncate" disabled={isModelLocked}>{models.map(m=><option key={m} value={m}>{m}</option>)}</select></div>
                                    </div>
                                )}
                            </div>

                            <div className="flex gap-3 pt-2">
                                <button onClick={savePreset} className="bg-neutral-800 text-neutral-400 p-4 rounded-xl border border-neutral-800 active:scale-95"><Icons.Save size={20}/></button>
                                <button onClick={generate} disabled={isGenerating||!isConnected} className={`flex-1 font-bold text-lg rounded-xl flex items-center justify-center gap-2 shadow-lg active:scale-[0.98] ${isGenerating?'bg-neutral-800 text-neutral-500':'bg-emerald-600 text-white shadow-emerald-900/20'}`}>{isGenerating?'...':'GERAR'}</button>
                            </div>
                        </div>
                    )}

                    {/* LIBRARY */}
                    {activeTab === 'library' && (
                        <div className="p-4 space-y-6 fade-in">
                            <div className="bg-neutral-900 border border-neutral-800 p-5 rounded-2xl relative overflow-hidden">
                                <h3 className="text-sm font-bold text-purple-400 mb-2 flex items-center gap-2"><Icons.FileJson size={16}/> Importar Workflow</h3>
                                <label className="block w-full bg-neutral-950/50 border border-dashed border-neutral-700 p-4 rounded-xl text-center text-xs text-neutral-400 cursor-pointer">{customWorkflowName || 'Selecionar JSON'}<input type="file" accept=".json" onChange={handleJson} className="hidden"/></label>
                            </div>
                            <div className="space-y-2">
                                {presets.map((p,i)=>(
                                    <div key={i} className="bg-neutral-900 border border-neutral-800 p-4 rounded-2xl flex justify-between items-center"><div onClick={()=>loadPreset(p)} className="flex-1 cursor-pointer"><h4 className="font-bold text-sm text-neutral-200">{p.name}</h4><span className="text-xs text-neutral-500">{p.steps} steps</span></div><button onClick={()=>{const n=presets.filter((_,x)=>x!==i);setPresets(n);localStorage.setItem('comfy_presets',JSON.stringify(n))}} className="text-red-500 p-2"><Icons.Trash2 size={18}/></button></div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* SETTINGS */}
                    {activeTab === 'settings' && (
                        <div className="p-5 fade-in">
                            <div className="bg-neutral-900 p-6 rounded-3xl border border-neutral-800 space-y-6">
                                <div className="flex items-center gap-3 text-neutral-200"><div className="bg-neutral-800 p-2.5 rounded-xl"><Icons.Settings size={24}/></div><div><h2 className="text-lg font-bold">Conexão</h2><p className="text-xs text-neutral-500">v13.0 Ngrok Support</p></div></div>
                                
                                {/* COMFY URL */}
                                <div><label className="text-xs font-bold text-neutral-500 uppercase ml-1 mb-1.5 block">ComfyUI URL (Tailscale/Ngrok)</label><div className="flex gap-2"><input value={serverUrl} onChange={handleUrlChange} className="flex-1 bg-neutral-950 border-2 border-neutral-800 rounded-xl p-4 font-mono text-sm focus:border-emerald-500 outline-none" placeholder="https://..." /><button onClick={()=>handlePaste(setServerUrl, 'comfy_url')} className="bg-neutral-800 px-4 rounded-xl text-neutral-400"><Icons.Clipboard size={20}/></button></div></div>
                                
                                {/* LLM URL */}
                                <div><label className="text-xs font-bold text-purple-500 uppercase ml-1 mb-1.5 block">LLM URL (Opcional - Ngrok 1234)</label><div className="flex gap-2"><input value={llmServerUrl} onChange={handleLlmUrlChange} className="flex-1 bg-neutral-950 border-2 border-neutral-800 rounded-xl p-4 font-mono text-sm focus:border-purple-500 outline-none text-purple-200" placeholder="https://..." /><button onClick={()=>handlePaste(setLlmServerUrl, 'comfy_llm_url')} className="bg-neutral-800 px-4 rounded-xl text-purple-400"><Icons.Clipboard size={20}/></button></div><p className="text-[10px] text-neutral-600 mt-1 ml-1">Deixe em branco para usar o mesmo IP do ComfyUI.</p></div>

                                <button onClick={()=>checkConnection(serverUrl)} className="w-full py-4 rounded-xl font-bold bg-neutral-100 text-black flex justify-center items-center gap-2 active:scale-95">{isConnected?<Icons.CheckCircle size={20}/>:<Icons.RefreshCw size={20}/>} {isConnected?'Reconectar':'Conectar'}</button>
                            </div>
                        </div>
                    )}

                    {/* HISTORY */}
                    {activeTab === 'history' && (
                        <div className="p-4 grid grid-cols-2 gap-3 fade-in pb-20">
                            {history.map((img,i)=>(
                                <div key={i} className="rounded-2xl overflow-hidden relative bg-neutral-900 aspect-square shadow-lg">
                                    <img src={img.url} className="w-full h-full object-cover" />
                                    <button onClick={()=>downloadImage(img.url, `galeria_${i}.png`)} className="absolute bottom-2 right-2 bg-black/60 text-white p-2 rounded-full backdrop-blur"><Icons.Download size={16}/></button>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* NAV */}
                    <div className="fixed bottom-0 w-full bg-neutral-950/90 backdrop-blur border-t border-neutral-900 flex justify-around p-2 pb-6 z-50">
                        <NavItem id="settings" icon={Icons.Settings} label="Config"/>
                        <NavItem id="generate" icon={Icons.Zap} label="Studio"/>
                        <NavItem id="library" icon={Icons.FolderOpen} label="Presets"/>
                        <NavItem id="history" icon={Icons.History} label="Galeria"/>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
